<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>VITAC – Visualizador de Tallas y Capturas (Compat)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --cols: 7; --rows: 30; }
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
  #grid { display: grid; grid-template-columns: repeat(7, 1fr);
          grid-template-rows: repeat(30, 1fr); height: 100vh; gap: 4px;
          padding: 4px; background: #fafafa; }
  .cell { border: 1px solid #e0e0e0; background:#fff; border-radius:4px; }

  #logo { grid-column: 1 / 2; grid-row: 1 / 5; background: #004f9e;
          display: flex; align-items: center; justify-content: center; overflow: hidden; }
  #logo img { max-width: 100%; max-height: 100%; object-fit: contain; }

  #selector { grid-column: 1 / 2; grid-row: 5 / 31; background: #f1f1f1;
              padding: 6px; overflow-y: auto; border-radius: 4px;
              display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
  #selector button { width: 100%; padding: 6px 4px; border: 1px solid #ccc;
                     background: #fff; cursor: pointer; border-radius: 3px;
                     transition: background 0.2s; font-size: 0.85rem; }
  #selector button:hover { background: #e8e8ff; }
  #selector button.active { background: #004f9e; color: #fff; }

  #chartMcolaCont { grid-column: 2 / 4; grid-row: 1 / 14; display:flex; align-items:center; justify-content:center; padding:8px; }
  #chartMsurCont  { grid-column: 2 / 4; grid-row: 16 / 29; display:flex; align-items:center; justify-content:center; padding:8px; }
  #chartMcola, #chartMsur { width:100%; height:100%; }

  #infoPanel, #infoPanelMsur { display:flex; justify-content:space-between; align-items:center; gap:6px; padding:4px 6px; font-size:.8rem; }
  #infoPanel     { grid-column: 2 / 4; grid-row: 14 / 16; }
  #infoPanelMsur { grid-column: 2 / 4; grid-row: 29 / 31; }
  .infoBox { display:flex; align-items:baseline; background:#f9f9f9; border:1px solid #ddd; border-radius:3px; padding:2px 4px; gap:4px; white-space:nowrap; }
  .infoBox .label{ font-weight:700; }
  .infoBox .value{ font-weight:600; }

  #donutCaptCont { grid-column: 4 / 6; grid-row: 1 / 23; display:flex; align-items:center; justify-content:center; padding:8px; }
  #donutCapt { width:100%; height:100%; }

  #panelLance { grid-column: 4 / 6; grid-row: 23 / 31; display:flex; flex-direction:column; gap:6px; padding:8px; font-size:.8rem; }
  .legend { display:flex; justify-content:center; gap:12px; font-weight:600; }
  .legend .sq { display:inline-block; width:10px; height:10px; margin-right:4px; }
  .sq.mcola{ background:#f28e2b; } .sq.msur{ background:#4e79a7; } .sq.otros{ background:#76b7b2; }
  .kgs{ display:flex; justify-content:center; gap:24px; }
  .kgBox{ border:1px solid #000; padding:6px 16px; font-size:1rem; font-weight:700; }
  .meta{ border-collapse:collapse; width:100%; }
  .meta th,.meta td{ border:1px solid #000; padding:4px; text-align:center; }
  .meta th{ background:#f0f0f0; }

  #mapLance{ grid-column: 6 / 8; grid-row: 1 / 31; width:100%; height:100%; border:1px solid #ddd; border-radius:4px; }
  .lance-icon div{ width:14px; height:14px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 2px #0003; }
  .leaflet-tooltip.lance-label{ background:#fff; border:1px solid #999; border-radius:3px; padding:2px 4px; font-size:11px; font-weight:bold; color:#333; }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Chart.js v3 para mayor compatibilidad -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
  <div id="grid">
    <div id="logo" class="cell">
      <img src="logo_vitac.png" alt="Logo VITAC">
    </div>

    <div id="selector" class="cell"></div>

    <div id="chartMcolaCont" class="cell"><canvas id="chartMcola"></canvas></div>
    <div id="infoPanel" class="cell">
      <div class="infoBox"><span class="label">MODA</span><span id="valModa" class="value">–</span></div>
      <div class="infoBox"><span class="label">FREC</span><span id="valFrec" class="value">–</span></div>
      <div class="infoBox"><span class="label">RANGO</span><span id="valRango" class="value">–</span></div>
      <div class="infoBox"><span class="label">TOTAL</span><span id="valTotal" class="value">–</span></div>
    </div>

    <div id="chartMsurCont" class="cell"><canvas id="chartMsur"></canvas></div>
    <div id="infoPanelMsur" class="cell">
      <div class="infoBox"><span class="label">MODA</span><span id="valModaS" class="value">–</span></div>
      <div class="infoBox"><span class="label">FREC</span><span id="valFrecS" class="value">–</span></div>
      <div class="infoBox"><span class="label">RANGO</span><span id="valRangoS" class="value">–</span></div>
      <div class="infoBox"><span class="label">TOTAL</span><span id="valTotalS" class="value">–</span></div>
    </div>

    <div id="donutCaptCont" class="cell"><canvas id="donutCapt"></canvas></div>

    <div id="panelLance" class="cell">
      <div class="legend">
        <span><span class="sq mcola"></span> Merluza cola</span>
        <span><span class="sq msur"></span> Merluza sur</span>
        <span><span class="sq otros"></span> Otros</span>
      </div>
      <div class="kgs">
        <div class="kgBox"><span id="kgMcola">–</span> kg</div>
        <div class="kgBox"><span id="kgMsur">–</span> kg</div>
        <div class="kgBox"><span id="kgOtros">–</span> kg</div>
      </div>
      <table class="meta">
        <thead><tr><th>FECHA</th><th>LATITUD</th><th>LONGITUD</th></tr></thead>
        <tbody><tr><td id="metaFecha"></td><td id="metaLat"></td><td id="metaLon"></td></tr></tbody>
      </table>
    </div>

    <div id="mapLance" class="cell"></div>
  </div>

<script>
var lances=[], classes=[], dataByLance={}, dataMsur={}, dataCapt={}, lanceInfo={}, coordsLance={};

var selectedLances = []; // array simple para compatibilidad
var palette = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];
function colorFor(l){ return palette[(Number(l)-1)%palette.length]; }
function makeLanceIcon(l){
  var col=colorFor(l);
  return L.divIcon({className:'lance-icon', html:'<div style="background:'+col+'"></div>', iconSize:[18,18], iconAnchor:[9,9]});
}

function inSelected(n){
  for(var i=0;i<selectedLances.length;i++){ if(selectedLances[i]==n) return true; }
  return false;
}
function addOrRemove(n){
  if(inSelected(n)){
    // remove
    var arr=[]; for(var i=0;i<selectedLances.length;i++){ if(selectedLances[i]!=n) arr.push(selectedLances[i]); }
    selectedLances = arr;
  }else{
    selectedLances.push(n);
  }
  if(selectedLances.length===0) selectedLances=[n];
}

function buildSelector(){
  var sel = document.getElementById('selector');
  sel.innerHTML = '';
  for(var i=0;i<lances.length;i++){
    (function(n){
      var b=document.createElement('button');
      b.textContent='Lance '+n; b.setAttribute('data-lance', n);
      b.onclick=function(){ toggleSelect(n); };
      sel.appendChild(b);
    })(lances[i]);
  }
}
function toggleSelect(n){
  addOrRemove(n);
  updateButtons(); drawChart(); drawMsurChart(); drawDonut(); showMap(); updatePanels();
}
function updateButtons(){
  var btns=document.querySelectorAll('#selector button');
  for(var i=0;i<btns.length;i++){
    var n=Number(btns[i].getAttribute('data-lance'));
    var active=inSelected(n);
    if(active) btns[i].classList.add('active'); else btns[i].classList.remove('active');
    btns[i].setAttribute('aria-pressed', active);
  }
}

/* ---- M. cola ---- */
var chartMcola=null;
function drawChart(){
  var ctx=document.getElementById('chartMcola').getContext('2d');
  var datasets=[];
  for(var i=0;i<selectedLances.length;i++){
    var l=selectedLances[i];
    datasets.push({
      label:'Lance '+l,
      data: (dataByLance[l] || dataByLance[String(l)] || []),
      fill:false, tension:.3, borderWidth:2, pointRadius:3,
      borderColor: colorFor(l), pointBackgroundColor: colorFor(l)
    });
  }
  if(chartMcola){
    chartMcola.data.labels = classes; chartMcola.data.datasets = datasets;
    chartMcola.options.plugins.title.text='Merluza de Cola – Lances '+selectedLances.join(', ');
    chartMcola.update();
  }else{
    chartMcola = new Chart(ctx,{type:'line', data:{labels:classes, datasets:datasets},
      options:{responsive:true, maintainAspectRatio:false,
        plugins:{legend:{position:'top'}, title:{display:true,text:'Merluza de Cola'}},
        scales:{y:{beginAtZero:true, title:{display:true,text:'Frecuencia'}},
                x:{title:{display:true,text:'Talla (cm)'}}}});
  }
}

/* ---- M. sur ---- */
var chartMsur=null;
function drawMsurChart(){
  var ctx=document.getElementById('chartMsur').getContext('2d');
  var datasets=[];
  for(var i=0;i<selectedLances.length;i++){
    var l=selectedLances[i];
    datasets.push({
      label:'Lance '+l,
      data: (dataMsur[l] || dataMsur[String(l)] || []),
      fill:false, tension:.3, borderWidth:2, pointRadius:3,
      borderColor: colorFor(l), pointBackgroundColor: colorFor(l)
    });
  }
  if(chartMsur){
    chartMsur.data.labels = classes; chartMsur.data.datasets = datasets;
    chartMsur.options.plugins.title.text='Merluza del Sur – Lances '+selectedLances.join(', ');
    chartMsur.update();
  }else{
    chartMsur = new Chart(ctx,{type:'line', data:{labels:classes, datasets:datasets},
      options:{responsive:true, maintainAspectRatio:false,
        plugins:{legend:{position:'top'}, title:{display:true,text:'Merluza del Sur'}},
        scales:{y:{beginAtZero:true, title:{display:true,text:'Frecuencia'}},
                x:{title:{display:true,text:'Talla (cm)'}}}});
  }
}

/* ---- Info panels (solo cuando hay 1 lance) ---- */
function updatePanels(){
  var single = (selectedLances.length===1);
  var ids=['infoPanel','infoPanelMsur','panelLance','donutCaptCont'];
  for(var i=0;i<ids.length;i++){
    var el=document.getElementById(ids[i]); if(!el) continue; el.style.display = single? '': 'none';
  }
  if(single){
    var l = selectedLances[0];
    updateInfoPanel(l);
    updateInfoMsur(l);
    updateLancePanel(l);
  }
}
function firstNonZero(arr){
  for(var i=0;i<arr.length;i++){ if(arr[i]>0) return i; } return -1;
}
function lastNonZero(arr){
  for(var i=arr.length-1;i>=0;i--){ if(arr[i]>0) return i; } return -1;
}
function maxIndex(arr){
  var max=-1, idx=-1;
  for(var i=0;i<arr.length;i++){ if(arr[i]>max){ max=arr[i]; idx=i; } }
  return {max:max, idx:idx};
}
function sum(arr){ var s=0; for(var i=0;i<arr.length;i++) s+=arr[i]; return s; }

function updateInfoPanel(l){
  var arr = (dataByLance[l] || dataByLance[String(l)] || []);
  var t = sum(arr);
  var mm = maxIndex(arr);
  var first = firstNonZero(arr);
  var last  = lastNonZero(arr);
  var rango = (first===-1)? '–' : (classes[first]+' / '+classes[last]);
  document.getElementById('valModa').textContent  = (mm.idx>=0?classes[mm.idx]:'–');
  document.getElementById('valFrec').textContent  = (mm.max>0?mm.max:0);
  document.getElementById('valRango').textContent = rango;
  document.getElementById('valTotal').textContent = t;
}
function updateInfoMsur(l){
  var arr = (dataMsur[l] || dataMsur[String(l)] || []);
  var t = sum(arr);
  var mm = maxIndex(arr);
  var first = firstNonZero(arr);
  var last  = lastNonZero(arr);
  var rango = (first===-1)? '–' : (classes[first]+' / '+classes[last]);
  document.getElementById('valModaS').textContent  = (mm.idx>=0?classes[mm.idx]:'–');
  document.getElementById('valFrecS').textContent  = (mm.max>0?mm.max:0);
  document.getElementById('valRangoS').textContent = rango;
  document.getElementById('valTotalS').textContent = t;
}
function updateLancePanel(l){
  var d = (lanceInfo[l] || lanceInfo[String(l)]);
  if(!d) return;
  var msur = (d.Msur!=null? d.Msur:0);
  var mcola = (d.Mcola!=null? d.Mcola:0);
  var otros = (d.Otros!=null? d.Otros:0);
  document.getElementById('kgMsur').textContent  = msur.toFixed(1);
  document.getElementById('kgMcola').textContent = mcola.toFixed(1);
  document.getElementById('kgOtros').textContent = otros.toFixed(1);
  document.getElementById('metaFecha').textContent = d.Fecha || '';
  document.getElementById('metaLat').textContent   = d.Lat || '';
  document.getElementById('metaLon').textContent   = d.Lon || '';
}

/* ---- Donut ---- */
var chartDonut=null;
function aggregateCapturas(){
  var sumA=[0,0,0];
  for(var i=0;i<selectedLances.length;i++){
    var l=selectedLances[i];
    var v = dataCapt[l] || dataCapt[String(l)];
    if(v){ sumA[0]+=v[0]; sumA[1]+=v[1]; sumA[2]+=v[2]; }
  }
  return sumA;
}
function drawDonut(){
  var vals = aggregateCapturas();
  var ctx = document.getElementById('donutCapt').getContext('2d');
  if(chartDonut){
    chartDonut.data.datasets[0].data = vals;
    chartDonut.options.plugins.title.text = 'Capturas';
    chartDonut.update();
  }else{
    chartDonut = new Chart(ctx,{type:'doughnut',
      data:{labels:['Merluza Sur','Merluza Cola','Otros'], datasets:[{data:vals, backgroundColor:['#4e79a7','#f28e2b','#76b7b2'], borderWidth:1}]},
      options:{plugins:{legend:{position:'bottom'}, title:{display:true,text:'Capturas'}}}});
  }
}

/* ---- Mapa ---- */
var mapL=null, markers=[];
function initMap(){
  mapL = L.map('mapLance').setView([-43,-75], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(mapL);
}
function showMap(){
  if(!mapL) initMap();
  for(var i=0;i<markers.length;i++){ mapL.removeLayer(markers[i]); }
  markers=[];
  for(var j=0;j<selectedLances.length;j++){
    var l=selectedLances[j];
    var p = coordsLance[l] || coordsLance[String(l)];
    if(!p) continue;
    var m = L.marker(p,{icon:makeLanceIcon(l)}).addTo(mapL)
                .bindTooltip('Lance '+l,{permanent:true,direction:'top',offset:[0,-10],className:'lance-label'});
    markers.push(m);
  }
  if(markers.length){
    var group = new L.featureGroup(markers);
    mapL.fitBounds(group.getBounds().pad(0.3));
  }
}

/* ---- Carga de datos + arranque ---- */
function boot(){
  fetch('data.json', {cache: 'no-store'})
    .then(function(resp){ return resp.json(); })
    .then(function(J){
      lances = J.lances; classes = J.classes;
      dataByLance = J.dataByLance; dataMsur = J.dataMsur;
      dataCapt = J.dataCapt; lanceInfo = J.lanceInfo; coordsLance = J.coordsLance;

      buildSelector();
      selectedLances=[lances[0]]; updateButtons();
      drawChart(); drawMsurChart(); drawDonut(); showMap(); updatePanels();
    })
    .catch(function(err){
      console.error('Error cargando data.json:', err);
      alert('No pude cargar data.json. Revisa que esté en el mismo directorio.');
    });
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
